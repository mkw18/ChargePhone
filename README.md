# ChargePhone

## 一、整体架构
用户从输入模块输入自己的充值金额，控制模块接收输入模块的信息，并控制输出模块显示金额余额和剩余充电时间。初始状态为待机状态；之后在用户有输入时，进入输入状态；如果用户长时间不操作，则回到初始状态；用户确认输入金额后，进入充电状态；充电状态结束后，如果长时间不操作，则回到初始状态。状态转换图如下：

![image](https://github.com/mkw18/ChargePhone/blob/master/img/p2.png)
## 二、操作过程

![image](https://github.com/mkw18/ChargePhone/blob/master/img/p5.png)

其中，按键布局如下：

![image](https://github.com/mkw18/ChargePhone/blob/master/img/p4.png)
## 三、分模块讲解
1. 分频模块freq：将晶振的50MHz的频率降低到25kHz，便于之后的使用。输入为CLK，输出为OCLK。

为便于后级模块使用同步时钟，将晶振分频至合理值。本次设计将晶振时钟分频为25kHz，即每接收到1000个晶振时钟信号翻转一次。

2. 输入模块keyMatrix：将键盘上的按键转化为对应的编码，同时通过这些编码转化为具体对应的输入信息。输入为CLK,C，输出为R, startSet, num, start, clear, enter。

（1）输入列信号，在没有按键且列信号为4’b1111时遍历行信号。

（2）通过声明negCnt和posCnt分别对于按键前后时间长短的检查，以及每次确定按键后对于negCnt和posCnt的清零以便重新计数，实现防抖功能。
 
（3）确定按键后，通过确定按键的上升沿信号进行键盘的编码，与防抖相配合，可以解决长按键问题，即即使一直按着，在合理扰动范围内，编码不会改变。
 
（4）通过列C与行R的状态，将矩阵键盘按下键进行编码得到key。
 
（5）通过得到的编码，转化为对应的数字或者start, clear, enter信号。

3. 控制模块mechine：实现电路的具体功能。输入为CLK, startSet, num, start, clear, enter，输出为money,restime。

（1）状态转换：初始状态为S0，按下开始键后进入S1状态，其他按键均保留在S0状态；进入S1状态之后，若money和restime均为0，10秒钟无动作后回到S0状态，若money和restime不为0，且按下了enter键，进入S2状态，其他按键均停留在S1状态；进入S2状态后，倒计时未结束前，一直在S2状态，倒计时结束后，进入S1状态。

（2）有效按键：检测到按键后，需要确定按下状态的前一个状态是未按下，该按下信息才有效，且与之前的防抖配合，以解决长按键问题。

（3）S0状态：初始状态，除了按下start键以外均无效。

（4）S1状态：若按下clear，则清零并重设时钟，开始10秒倒计时，若是从初始状态进入S1状态而money为0，则也重设时钟进行10秒钟倒计时。如果输入的num为有效值（即0-9），则关闭10秒钟倒计时，并开始进行金额和时间的设置。先将下个金额数阻塞性赋值到next_money，若小于20，则同时赋值给money和restime，否则分别将20和40赋值给money和restime。

（5）10秒钟倒计时设置：如果时钟信号开启且没有重设时钟信号，则进行十秒钟倒计时。pause设置为正常的十秒钟，即250000个时钟信号。经过十秒钟后，回到S0状态。

（6）S2状态：进入充电倒计时，second设置为实际的1秒钟，即25000个时钟信号。time_count进行25000次计数后倒计时一秒。restime为1时，让下一个状态的money为0，这样时间和金额可以同时归零。当money为0后，状态回到S1并开始10秒钟倒计时。

4. 显示模块showall：包括两个模块，位选模块DigChoose和显示模块show。位选模块选择数码管进行显示，显示模块将具体数字显示在相应数码管上。输入为CLK,money,restime，输出为dig,seg。

包括两个模块：数码管位选模块及相应的输出，数码管显示模块。

（1）数码管位选模块及对应输出：若money为设定的无效值，则仅对应DIG3，且将num设为无效值若money为有效值，则轮流显示四个数码管，且每个数码管显示对应要显示的数。由于是同步电路，所以数值为下一状态显示数码管对应的数值。如果没有对应的数码管位选信号，则将num设为无效值。

（2）数码管显示模块：将num对应到七段显示译码管的编码，同时对于无效值，应使七段显示译码管全灭。

（3）合并：直接将两模块合并，即得输出模块。
